<h1 class="page-title">Your Final Cover Letter and Video Pitch</h1>
<h2 class="page-subtitle mb-5">
  Your final cover letter and video pitch are ready to be used
</h2>

<div class="container-fluid">
  <div class="d-flex justify-content-center" style="width: 1400px; margin: 0 auto;">
    <div class="d-flex flex-column" style="width: 100%;">
      <div class="d-flex justify-content-between align-items-center mb-4 p-4 rounded-4 shadow bg-white border">
        <div class="pe-4">
          <h1 class="h4 mb-2">
            <strong class="text-secondary fw-normal">Role applied for:</strong>
            <strong class="text-dark"><%= @application.title %></strong>
          </h1>
          <h2 class="h6 text-muted mb-0">
            <strong class="fw-normal">Company:</strong>
            <span class="text-secondary"><%= @application.name %></span>
          </h2>
        </div>
        <div class="text-end text-muted small ps-4">
          <div class="mb-1">
            <strong>Created On:</strong> <%= @application.created_at.strftime("%b %d, %Y") %>
          </div>
          <div>
            <strong>Last Updated:</strong> <%= @application.updated_at.strftime("%b %d, %Y") %>
          </div>
        </div>
      </div>

      <div class="d-flex gap-4 align-items-start" style="width: 1400px;">
        <div class="d-flex flex-column gap-4" style="flex: 0 0 20%;">
          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 20%; max-width: 20%; min-width: 200px; height: 425px;">
            <h2 class="h5 mb-4 text-center"><strong>Your Selections</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2 overflow-auto">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Tone</h6>
                  <p class="small mb-0"><%= session[:trait_choice1] || "Not selected" %></p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Professional Strength</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice2] == "Other" %>
                      <%= session[:trait_choice2_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice2] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Highlight an accomplishment</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice3] == "Other" %>
                      <%= session[:trait_choice3_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice3] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Video Pitch Personality</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice4] == "Other" %>
                      <%= session[:trait_choice4_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice4] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 20%; max-width: 20%; min-width: 200px; height: 150px;">
            <h2 class="h5 mb-4 text-center"><strong>Documents</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2">
                <% if @application.cv.attached? %>
                  <div class="d-flex align-items-center justify-content-between">
                    <a href="<%= url_for(@application.cv) %>" target="_blank" class="align-items-center">
                      <i class="bi bi-file-earmark-text me-2"></i>
                      <span class="text-truncate" style="max-width: 140px;">
                        <%= @application.cv.filename %>
                      </span>
                    </a>
                    <a href="<%= url_for(@application.cv) %>" download="<%= @application.cv.filename %>" class="btn btn-sm" title="Download CV" style="color: #6c757d; border: none; background: none;">
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                <% else %>
                  <p class="text-muted small">No CV uploaded.</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Cover Letter</strong></h2>
            <div class="d-flex gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-sm"
                onclick="navigator.clipboard.writeText(document.getElementById('coverLetterContent').innerText); this.innerHTML = '<i class=\'bi bi-check\'></i>'; setTimeout(() => { this.innerHTML = '<i class=\'bi bi-copy\'></i>' }, 2000);"
                title="Copy to clipboard"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-copy"></i>
              </button>
              <a
                class="btn btn-sm"
                href="data:text/plain;charset=utf-8,<%= ERB::Util.url_encode(@application.finals.last.cl || '') %>"
                download="cover_letter_<%= @application.title.parameterize.underscore %>.txt"
                title="Download as .txt"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-download"></i>
              </a>
            </div>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div id="coverLetterContent" class="p-2 overflow-auto flex-grow-1">
              <%= simple_format(@application.finals.last.cl) %>
              <% if (video = @application.videos.last) && video.file.attached? %>
                <% cloudinary_url = url_for(video.file) %>
                <p>Please <a href="<%= cloudinary_url %>" target="_blank" rel="noopener">click here</a> to see the video.</p>
              <% end %>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Video Pitch</strong></h2>
.            <% if @video&.file&.attached? %>
              <a
                href="<%= url_for(@video.file) %>"
                download="<%= @video.file.filename %>"
                class="btn btn-link p-1"
                title="Download Video"
                style="color: #6c757d;"
              >
                <i class="bi bi-download" style="font-size: 1.2rem;"></i>
              </a>
            <% elsif @application.finals.last&.pitch.present? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  onclick="navigator.clipboard.writeText(document.getElementById('videoPitchContent').innerText); this.innerHTML = '<i class=\'bi bi-check\'></i>'; setTimeout(() => { this.innerHTML = '<i class=\'bi bi-copy\'></i>' }, 2000);"
                  title="Copy to clipboard"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-copy"></i>
                </button>
                <a
                  class="btn btn-sm"
                  href="data:text/plain;charset=utf-8,<%= ERB::Util.url_encode(@application.finals.last.pitch || '') %>"
                  download="video_pitch_<%= @application.title.parameterize.underscore %>.txt"
                  title="Download as .txt"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% end %>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div class="pt-4 px-2 d-flex justify-content-center align-items-start flex-grow-1 overflow-auto">
              <% if @video&.file&.attached? %>
                <video controls style="width: 100%; height: auto; max-height: 100%;">
                  <source src="<%= url_for(@video.file) %>" type="<%= @video.file.content_type %>">
                  Your browser does not support the video tag.
                </video>
              <% else %>
                <% if @application.finals.last&.pitch.present? %>
                  <div id="videoPitchContent" class="d-flex flex-wrap gap-3">
                    <% @application.finals.last.pitch.split("\n\n").each do |paragraph| %>
                      <% if paragraph.strip.present? %>
                        <div class="flex-fill">
                          <%= simple_format(paragraph) %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-muted text-center">
                    <i class="bi bi-camera-video" style="font-size: 3rem;"></i>
                    <p class="mt-2">Video pitch will appear here when uploaded</p>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>


      <div class="d-flex justify-content-center gap-2 m-4 p-6">
        <%= link_to "Go to Dashboard", applications_path, class: "btn btn-success px-4 py-2" %>
        <%= link_to "Create New Application", new_application_path, class: "btn btn-primary px-4 py-2" %>
      </div>
    </div>
  </div>
</div>
