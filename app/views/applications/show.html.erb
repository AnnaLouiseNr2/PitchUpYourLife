<div class="page-header">
  <h1 class="page-title">Your Final Cover Letter and Video Pitch</h1>
  <h2 class="page-subtitle">
    Your final cover letter and video pitch are ready to be used
  </h2>
</div>
<div class="container-fluid" data-controller="copy-share">
  <div class="d-flex justify-content-center" style="width: 1400px; margin: 0 auto;">
    <div class="d-flex flex-column" style="width: 100%;">
      <div class="d-flex justify-content-between align-items-center mb-4 p-4 rounded-4 shadow bg-white border">
        <div class="pe-4">
          <h1 class="h4 mb-2">
            <strong class="text-secondary fw-normal">Role applied for:</strong>
            <strong class="text-dark"><%= @application.title %></strong>
          </h1>
          <h2 class="h6 text-muted mb-0">
            <strong class="fw-normal">Company:</strong>
            <span class="text-secondary"><%= @application.name %></span>
          </h2>
        </div>
        <div class="text-end text-muted small ps-4">
          <div class="mb-1">
            <strong>Created On:</strong> <%= @application.created_at.strftime("%b %d, %Y") %>
          </div>
          <div>
            <strong>Last Updated:</strong> <%= @application.updated_at.strftime("%b %d, %Y") %>
          </div>
        </div>
      </div>

      <div class="d-flex gap-4 align-items-start" style="width: 1400px;">
        <div class="d-flex flex-column gap-4" style="flex: 0 0 20%; max-width: 20%;">
          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="height: 425px;">
            <h2 class="h5 mb-4 text-center"><strong>Your Selections</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2 overflow-auto">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Tone</h6>
                  <p class="small mb-0"><%= @trait.first || "Not selected" %></p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Professional Strength</h6>
                  <p class="small mb-0">
                    <% if @trait.second == "Other" %>
                      <%= @trait.second || "Not selected" %>
                    <% else %>
                      <%= @trait.second || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Highlight an accomplishment</h6>
                  <p class="small mb-0">
                    <% if @trait.third == "Other" %>
                      <%= @trait.third || "Not selected" %>
                    <% else %>
                      <%= @trait.third || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Video Pitch Personality</h6>
                  <p class="small mb-0">
                    <% if @trait.fourth == "Other" %>
                      <%= @trait.fourth || "Not selected" %>
                    <% else %>
                      <%= @trait.fourth || "Not selected" %>
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="height: 150px;">
            <h2 class="h5 mb-4 text-center"><strong>Documents</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2">
                <% if @application.cv.attached? %>
                  <div class="d-flex align-items-center gap-2" style="min-width: 0;">
                    <a href="<%= url_for(@application.cv) %>" target="_blank" class="d-flex align-items-center text-decoration-none flex-grow-1" style="min-width: 0; overflow: hidden;">
                      <i class="bi bi-file-earmark-text me-2 flex-shrink-0"></i>
                      <span class="text-truncate" style="max-width: 100%;">
                        <%= @application.cv.filename %>
                      </span>
                    </a>
                    <a href="<%= url_for(@application.cv) %>" download="<%= @application.cv.filename %>" class="btn btn-sm flex-shrink-0" title="Download CV" style="color: #6c757d; border: none; background: none;">
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                <% else %>
                  <p class="text-muted small">No CV uploaded.</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Cover Letter</strong></h2>
            <div class="d-flex gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-sm"
                onclick="navigator.clipboard.writeText(document.getElementById('coverLetterContent').innerText); this.innerHTML = '<i class=\'bi bi-check\'></i>'; setTimeout(() => { this.innerHTML = '<i class=\'bi bi-copy\'></i>' }, 2000);"
                title="Copy to clipboard"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-copy"></i>
              </button>
              <a
                class="btn btn-sm"
                href="data:text/plain;charset=utf-8,<%= ERB::Util.url_encode(@application.finals.last.cl || '') %>"
                download="cover_letter_<%= @application.title.parameterize.underscore %>.txt"
                title="Download as .txt"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-download"></i>
              </a>
            </div>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div id="coverLetterContent" class="p-2 overflow-auto flex-grow-1">
              <%= simple_format(@application.finals.last.cl) %>
              <% if (video = @application.videos.last) && video.file.attached? %>
                <% cloudinary_url = url_for(video.file) %>
                <p>Please <a href="<%= cloudinary_url %>" target="_blank" rel="noopener">click here</a> to see the video.</p>
              <% end %>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Video Pitch</strong></h2>
.            <% if (video = @application.videos.last) && video.file.attached? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  data-action="click->copy-share#openShareModal"
                  data-copy-share-share-url-param="<%= url_for(video.file) %>"
                  title="Share video link"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-share"></i>
                </button>
                <a
                  href="<%= url_for(video.file) %>"
                  download="<%= video.file.filename %>"
                  class="btn btn-sm"
                  title="Download Video"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% elsif @video&.file&.attached? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  data-action="click->copy-share#openShareModal"
                  data-copy-share-share-url-param="<%= url_for(@video.file) %>"
                  title="Share video link"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-share"></i>
                </button>
                <a
                  href="<%= url_for(@video.file) %>"
                  download="<%= @video.file.filename %>"
                  class="btn btn-sm"
                  title="Download Video"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% end %>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div class="pt-4 px-2 d-flex justify-content-center align-items-start flex-grow-1 overflow-auto">
              <% if (video = @application.videos.last) && video.file.attached? %>
                <video controls style="width: 100%; height: auto; max-height: 100%;">
                  <source src="<%= url_for(video.file) %>" type="<%= video.file.content_type %>">
                  Your browser does not support the video tag.
                </video>
              <% elsif @video&.file&.attached? %>
                <video controls style="width: 100%; height: auto; max-height: 100%;">
                  <source src="<%= url_for(@video.file) %>" type="<%= @video.file.content_type %>">
                  Your browser does not support the video tag.
                </video>
              <% else %>
                <% if @application.finals.last&.pitch.present? %>
                  <div id="videoPitchContent" class="d-flex flex-wrap gap-3">
                    <% @application.finals.last.pitch.split("\n\n").each do |paragraph| %>
                      <% if paragraph.strip.present? %>
                        <div class="flex-fill">
                          <%= simple_format(paragraph) %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-muted text-center">
                    <i class="bi bi-camera-video" style="font-size: 3rem;"></i>
                    <p class="mt-2">Video pitch will appear here when uploaded</p>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center gap-2 m-4 p-6">

        <%= link_to "Go to Dashboard", applications_path, class: "btn btn-success px-4 py-2" %>
        <%= link_to "Create New Application", new_application_path, class: "btn btn-primary px-4 py-2" %>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true" data-controller="copy-share">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0" style="border-radius: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); box-shadow: 0 20px 40px rgba(0,0,0,0.1);">

      <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0; padding: 2rem 2rem 1.5rem 2rem;">
        <div class="text-center w-100">
          <div class="d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; backdrop-filter: blur(10px);">
            <i class="bi bi-share" style="font-size: 1.8rem; color: white;"></i>
          </div>
          <h3 class="modal-title text-white mb-2 fw-bold" id="shareModalLabel">Share Your Video Pitch</h3>
          <p class="text-white mb-0" style="opacity: 0.9; font-size: 0.95rem;">Choose how you'd like to share your professional video pitch</p>
        </div>
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="opacity: 0.8;"></button>
      </div>

      <div class="modal-body p-4" style="padding: 2rem 2rem 1rem 2rem !important;">
        <div class="mb-4">
          <div class="p-4 bg-white border-0 shadow-sm" style="border-radius: 16px;">
            <div class="d-flex align-items-center mb-3">
              <div class="d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <i class="bi bi-link-45deg text-white" style="font-size: 1.2rem;"></i>
              </div>
              <h6 class="mb-0 fw-semibold text-dark">Direct Link</h6>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <input type="text" class="form-control flex-grow-1 border-0" id="videoUrl" readonly style="font-size: 0.9rem; background-color: #f8f9fa; padding: 12px 16px; border-radius: 12px; font-family: 'Monaco', 'Menlo', monospace;">
              <button class="btn flex-shrink-0 d-flex align-items-center justify-content-center" type="button" data-action="click->copy-share#copyContent" data-copy-share-content-id-param="videoUrl" title="Copy link" style="width: 44px; height: 44px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; color: white;">
                <i class="bi bi-copy" style="font-size: 1.1rem;"></i>
              </button>
            </div>
          </div>
        </div>

        <div>
          <div class="d-flex align-items-center mb-3">
            <div class="d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
              <i class="bi bi-broadcast text-white" style="font-size: 1.2rem;"></i>
            </div>
            <h6 class="mb-0 fw-semibold text-dark">Share On Social</h6>
          </div>
          <div class="row g-3">
            <div class="col-6">
              <a href="#" id="emailShare" class="btn w-100 d-flex align-items-center justify-content-center text-decoration-none" target="_blank" style="padding: 16px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 14px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                <i class="bi bi-envelope me-2" style="font-size: 1.3rem;"></i>
                <span class="fw-semibold">Email</span>
              </a>
            </div>
            <div class="col-6">
              <a href="#" id="whatsappShare" class="btn w-100 d-flex align-items-center justify-content-center text-decoration-none" target="_blank" style="padding: 16px 12px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 14px; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);">
                <i class="bi bi-whatsapp me-2" style="font-size: 1.3rem;"></i>
                <span class="fw-semibold">WhatsApp</span>
              </a>
            </div>
            <div class="col-6">
              <a href="#" id="linkedinShare" class="btn w-100 d-flex align-items-center justify-content-center text-decoration-none" target="_blank" style="padding: 16px 12px; background: linear-gradient(135deg, #0077B5 0%, #005885 100%); color: white; border: none; border-radius: 14px; box-shadow: 0 4px 15px rgba(0, 119, 181, 0.4);">
                <i class="bi bi-linkedin me-2" style="font-size: 1.3rem;"></i>
                <span class="fw-semibold">LinkedIn</span>
              </a>
            </div>
            <div class="col-6">
              <a href="#" id="twitterShare" class="btn w-100 d-flex align-items-center justify-content-center text-decoration-none" target="_blank" style="padding: 16px 12px; background: linear-gradient(135deg, #1DA1F2 0%, #1a91da 100%); color: white; border: none; border-radius: 14px; box-shadow: 0 4px 15px rgba(29, 161, 242, 0.4);">
                <i class="bi bi-twitter me-2" style="font-size: 1.3rem;"></i>
                <span class="fw-semibold">Twitter</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 d-flex justify-content-center" style="padding: 1rem 2rem 2rem 2rem;">
        <button type="button" class="btn px-5 py-2" data-bs-dismiss="modal" style="background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px solid rgba(108, 117, 125, 0.2); border-radius: 12px; font-weight: 500;">Close</button>
      </div>
    </div>
  </div>
</div>
