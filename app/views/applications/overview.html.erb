<h1 class="page-title">Review your Cover Letter and Video Pitch</h1>
<h2 class="page-subtitle mb-5">
  Please review the draft cover letter and video pitch. Regenerate to get more options
</h2>

<div class="container-fluid">
  <div class="d-flex justify-content-center">
    <div class="d-flex flex-column" style="max-width: 1400px; width: 100%;">
      <!-- Parent flexbox container for all three sections -->
      <div class="d-flex gap-4 justify-content-center">
        <!-- Your Selections -->
        <div class="d-flex flex-column" style="flex: 0 0 20%; min-width: 200px;">
          <h2 class="h5 mb-4 text-center">Your Selections</h2>
          <div class="d-flex flex-column p-3 border rounded flex-grow-1" style="height: 450px;">
            <div class="flex-grow-1 p-2 overflow-auto">
            <div class="mb-3">
              <h6 class="small text-muted mb-2">Tone</h6>
              <p class="small mb-0"><%= session[:trait_choice1] || "Not selected" %></p>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <h6 class="small text-muted mb-2">Professional Strength</h6>
              <p class="small mb-0">
                <% if session[:trait_choice2] == "Other" %>
                  <%= session[:trait_choice2_other] || "Not specified" %>
                <% else %>
                  <%= session[:trait_choice2] || "Not selected" %>
                <% end %>
              </p>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <h6 class="small text-muted mb-2">Experience Level</h6>
              <p class="small mb-0"><%= session[:trait_choice3] || "Not selected" %></p>
            </div>

            <hr class="my-3">

            <div class="mb-3">
              <h6 class="small text-muted mb-2">Career Motivation</h6>
              <p class="small mb-0">
                <% if session[:trait_choice4] == "Other" %>
                  <%= session[:trait_choice4_other] || "Not specified" %>
                <% else %>
                  <%= session[:trait_choice4] || "Not selected" %>
                <% end %>
              </p>
            </div>
          </div>
        </div>
      </div>

        <!-- Review your Cover Letter -->
        <div class="d-flex flex-column" style="flex: 0 0 40%; min-width: 300px;">
          <h2 class="h5 mb-4 text-center">Review your Cover Letter</h2>
        <div class="d-flex flex-column p-3 border rounded flex-grow-1" style="height: 450px;">
          <div id="cl_output" class="flex-grow-1 mb-3 p-2 overflow-auto">
            <%= simple_format(@cl_message) %>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <%= button_to "Regenerate", generate_cl_application_path(@application, prompt_cl: @llm_prompt_cl),
                            method: :post,
                            class: "btn btn-outline-secondary w-100" %>
            </div>
            <div class="col-6">
              <%= form_with url: final_cl_application_path(@application), method: :post, id: "final-cl-form", class: "w-100" do |form| %>
                <%= form.hidden_field :final_cl, id: "final_cl_input" %>
                <%= form.submit "Finalize", class: "btn btn-primary w-100" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

        <!-- Review your Video Pitch -->
        <div class="d-flex flex-column" style="flex: 0 0 40%; min-width: 300px;">
          <h2 class="h5 mb-4 text-center">Review your Video Pitch</h2>
        <div class="d-flex flex-column p-3 border rounded flex-grow-1" style="height: 450px;">
          <div id="video_output" class="flex-grow-1 mb-3 p-2 overflow-auto">
            <%= simple_format(@video_message) %>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <%= button_to "Regenerate", generate_video_application_path(@application, prompt_video: @llm_prompt_video),
                                method: :post,
                                class: "btn btn-outline-secondary w-100" %>
            </div>
            <div class="col-6">
              <%= form_with url: final_pitch_application_path(@application), method: :post, id: "final-pitch-form", class: "w-100" do |form| %>
                <%= form.hidden_field :final_pitch, id: "final_pitch_input" %>
                <%= form.submit "Finalize", class: "btn btn-primary w-100" %>
              <% end %>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-center my-5">
  <%= link_to "Go to Final Application Page →", application_path(@application),
              class: "btn btn-primary px-4 py-2 disabled",
              id: "final-application-btn",
              onclick: "return checkIfBothFinalized(event);" %>
</div>

<script>
  let clFinalized = false;
  let pitchFinalized = false;

  function checkIfBothFinalized(event) {
    if (!clFinalized || !pitchFinalized) {
      event.preventDefault();
      alert("Please finalize both your Cover Letter and Video Pitch before proceeding.");
      return false;
    }
    return true;
  }

  function updateFinalButton() {
    const finalBtn = document.getElementById("final-application-btn");
    if (clFinalized && pitchFinalized) {
      finalBtn.classList.remove("disabled");
      finalBtn.classList.add("btn-success");
      finalBtn.classList.remove("btn-primary");
    } else {
      finalBtn.classList.add("disabled");
      finalBtn.classList.remove("btn-success");
      finalBtn.classList.add("btn-primary");
    }
  }

  document.getElementById("final-cl-form").addEventListener("submit", (event) => {
    const clOutput = document.getElementById("cl_output");
    document.getElementById("final_cl_input").value = clOutput.innerText;

    const submitBtn = event.target.querySelector('input[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.value = "Finalized ✓";
    submitBtn.classList.remove("btn-primary");
    submitBtn.classList.add("btn-success");

    clFinalized = true;
    updateFinalButton();
  });

  document.getElementById("final-pitch-form").addEventListener("submit", (event) => {
    const pitchOutput = document.getElementById("video_output");
    document.getElementById("final_pitch_input").value = pitchOutput.innerText;

    const submitBtn = event.target.querySelector('input[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.value = "Finalized ✓";
    submitBtn.classList.remove("btn-primary");
    submitBtn.classList.add("btn-success");

    pitchFinalized = true;
    updateFinalButton();
  });
</script>
